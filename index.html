<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKXèµ„äº§ç›‘æ§ v2.2</title>
    
    <!-- ç¼“å­˜æ§åˆ¶ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWAé…ç½® -->
    <meta name="theme-color" content="#00d2d3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OKXèµ„äº§">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    
    <!-- å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    
    <style>
        /* ä¹‹å‰çš„æ ·å¼ä¿æŒä¸å˜ï¼Œåªæ·»åŠ æ–°çš„æ ·å¼ */
        
        .storage-config {
            margin-top: 15px;
            padding: 15px;
            background: rgba(42, 51, 69, 0.3);
            border-radius: 8px;
        }
        
        .storage-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .storage-option {
            padding: 10px;
            background: #232c41;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            border: 1px solid #2a3345;
        }
        
        .storage-option.active {
            border-color: #00d2d3;
            background: rgba(0, 210, 211, 0.1);
        }
        
        .storage-option h4 {
            margin-bottom: 5px;
            color: #00d2d3;
        }
        
        .storage-option p {
            font-size: 12px;
            color: #8a94a6;
        }
        
        .sync-status {
            margin-top: 10px;
            font-size: 12px;
            color: #8a94a6;
        }
        
        .sync-status.syncing {
            color: #00d2d3;
        }
        
        .sync-status.success {
            color: #00c087;
        }
        
        .sync-status.error {
            color: #ff5b5a;
        }
        
        .github-config {
            margin-top: 10px;
            padding: 10px;
            background: rgba(42, 51, 69, 0.5);
            border-radius: 6px;
        }
        
        .github-config input {
            width: 100%;
            padding: 8px 12px;
            background: #232c41;
            border: 1px solid #2a3345;
            border-radius: 4px;
            color: #eaecef;
            margin-bottom: 5px;
        }
        
        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            background: #232c41;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="globalLoading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>æ­£åœ¨æ›´æ–°æ•°æ®...</div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>OKXèµ„äº§ç›‘æ§ v2.2</h1>
            <div class="last-update">æœ€åæ›´æ–°: <span id="update-time">--:--:--</span></div>
        </header>
        
        <div class="api-config card" id="api-config">
            <div class="card-title">APIé…ç½®</div>
            <div class="api-input-group">
                <label for="api-key">API Key</label>
                <input type="text" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„API Key">
            </div>
            <div class="api-input-group">
                <label for="secret-key">Secret Key</label>
                <input type="password" id="secret-key" placeholder="è¯·è¾“å…¥æ‚¨çš„Secret Key">
            </div>
            <div class="api-input-group">
                <label for="passphrase">Passphrase</label>
                <input type="password" id="passphrase" placeholder="è¯·è¾“å…¥æ‚¨çš„Passphrase">
            </div>
            
            <!-- æ•°æ®å­˜å‚¨é…ç½® -->
            <div class="storage-config">
                <div class="card-title">æ•°æ®å­˜å‚¨è®¾ç½®</div>
                <div class="storage-options">
                    <div class="storage-option active" data-storage="local">
                        <h4>ğŸ“± æœ¬åœ°å­˜å‚¨</h4>
                        <p>æ•°æ®ä¿å­˜åœ¨å½“å‰è®¾å¤‡</p>
                    </div>
                    <div class="storage-option" data-storage="github">
                        <h4>â˜ï¸ GitHubåŒæ­¥</h4>
                        <p>è·¨è®¾å¤‡æ•°æ®åŒæ­¥</p>
                    </div>
                    <div class="storage-option" data-storage="server">
                        <h4>ğŸ” ç§æœ‰æœåŠ¡å™¨</h4>
                        <p>æœ€é«˜å®‰å…¨æ€§</p>
                    </div>
                </div>
                
                <!-- GitHubé…ç½® -->
                <div class="github-config" id="github-config" style="display: none;">
                    <input type="text" id="github-token" placeholder="GitHub Personal Access Token">
                    <input type="text" id="github-gist" placeholder="Gist ID (ç•™ç©ºè‡ªåŠ¨åˆ›å»º)">
                    <button class="save-btn" onclick="saveGitHubConfig()" style="width: 100%;">ä¿å­˜GitHubé…ç½®</button>
                </div>
                
                <!-- æœåŠ¡å™¨é…ç½® -->
                <div class="github-config" id="server-config" style="display: none;">
                    <input type="text" id="server-url" placeholder="æœåŠ¡å™¨åœ°å€">
                    <input type="text" id="server-token" placeholder="è®¿é—®ä»¤ç‰Œ">
                    <button class="save-btn" onclick="saveServerConfig()" style="width: 100%;">ä¿å­˜æœåŠ¡å™¨é…ç½®</button>
                </div>
                
                <div class="sync-status" id="sync-status"></div>
                
                <div class="data-stats" id="data-stats">
                    <div class="stat-item">æ•°æ®ç‚¹: <span id="data-points">0</span></div>
                    <div class="stat-item">å¼€å§‹æ—¶é—´: <span id="data-start">--</span></div>
                    <div class="stat-item">å­˜å‚¨æ–¹å¼: <span id="storage-type">æœ¬åœ°</span></div>
                </div>
                
                <div style="margin-top: 10px;">
                    <button class="export-btn" onclick="exportAllData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                    <button class="export-btn" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                    <button class="clear-btn" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
            
            <div class="api-actions">
                <button class="save-btn" id="save-api">ä¿å­˜APIé…ç½®</button>
                <button class="clear-btn" id="clear-api">æ¸…é™¤é…ç½®</button>
            </div>
            <div id="api-status" class="status"></div>
        </div>
        
        <!-- å…¶ä»–éƒ¨åˆ†ä¿æŒä¸å˜ -->
    </div>

    <script>
        // ç‰ˆæœ¬æ§åˆ¶
        if (localStorage.getItem('appVersion') !== '2.2') {
            localStorage.clear();
            localStorage.setItem('appVersion', '2.2');
            console.log('å·²æ¸…é™¤æ—§ç¼“å­˜ï¼Œç‰ˆæœ¬æ›´æ–°åˆ° 2.2');
        }

        // å­˜å‚¨é…ç½®
        let storageConfig = {
            type: 'local', // local, github, server
            github: {
                token: '',
                gistId: ''
            },
            server: {
                url: '',
                token: ''
            }
        };

        // åŠ è½½å­˜å‚¨é…ç½®
        function loadStorageConfig() {
            const saved = localStorage.getItem('storageConfig');
            if (saved) {
                storageConfig = JSON.parse(saved);
                updateStorageUI();
            }
        }

        // æ›´æ–°å­˜å‚¨UI
        function updateStorageUI() {
            // æ›´æ–°é€‰é¡¹çŠ¶æ€
            document.querySelectorAll('.storage-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.storage === storageConfig.type) {
                    option.classList.add('active');
                }
            });
            
            // æ˜¾ç¤º/éšè—é…ç½®åŒºåŸŸ
            document.getElementById('github-config').style.display = 
                storageConfig.type === 'github' ? 'block' : 'none';
            document.getElementById('server-config').style.display = 
                storageConfig.type === 'server' ? 'block' : 'none';
            
            // æ›´æ–°å­˜å‚¨ç±»å‹æ˜¾ç¤º
            document.getElementById('storage-type').textContent = 
                storageConfig.type === 'local' ? 'æœ¬åœ°' : 
                storageConfig.type === 'github' ? 'GitHub' : 'æœåŠ¡å™¨';
        }

        // ========== æ•°æ®å­˜å‚¨æ ¸å¿ƒåŠŸèƒ½ ==========

        // ä¿å­˜å†å²æ•°æ®
        async function saveHistoricalData(totalAssets) {
            const now = new Date();
            const timestamp = now.getTime();
            const dateKey = now.toISOString().split('T')[0];
            
            // è·å–ç°æœ‰æ•°æ®
            let historicalData = JSON.parse(localStorage.getItem('okxHistoricalData') || '{}');
            let hourlyData = JSON.parse(localStorage.getItem('okxHourlyData') || '[]');
            
            // æ›´æ–°æ•°æ®
            historicalData[dateKey] = {
                timestamp: timestamp,
                total: totalAssets,
                date: dateKey
            };
            
            // å°æ—¶æ•°æ®ï¼ˆæ¯30åˆ†é’Ÿè®°å½•ä¸€æ¬¡ï¼‰
            const lastHourlyData = hourlyData[hourlyData.length - 1];
            if (!lastHourlyData || (timestamp - lastHourlyData.timestamp) > 30 * 60 * 1000) {
                hourlyData.push({
                    timestamp: timestamp,
                    total: totalAssets,
                    time: now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                });
                
                // ä¿ç•™æœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
                if (hourlyData.length > 1000) {
                    hourlyData = hourlyData.slice(-1000);
                }
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('okxHistoricalData', JSON.stringify(historicalData));
            localStorage.setItem('okxHourlyData', JSON.stringify(hourlyData));
            
            // åŒæ­¥åˆ°äº‘ç«¯
            await syncDataToCloud({
                historicalData,
                hourlyData,
                lastUpdate: timestamp
            });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateDataStats();
            
            return { historicalData, hourlyData };
        }

        // åŒæ­¥æ•°æ®åˆ°äº‘ç«¯
        async function syncDataToCloud(data) {
            if (storageConfig.type === 'local') return;
            
            const syncStatus = document.getElementById('sync-status');
            syncStatus.textContent = 'æ­£åœ¨åŒæ­¥æ•°æ®...';
            syncStatus.className = 'sync-status syncing';
            
            try {
                if (storageConfig.type === 'github') {
                    await syncToGitHub(data);
                } else if (storageConfig.type === 'server') {
                    await syncToServer(data);
                }
                
                syncStatus.textContent = 'æ•°æ®åŒæ­¥æˆåŠŸ';
                syncStatus.className = 'sync-status success';
                
                setTimeout(() => {
                    syncStatus.textContent = '';
                }, 3000);
            } catch (error) {
                console.error('æ•°æ®åŒæ­¥å¤±è´¥:', error);
                syncStatus.textContent = 'åŒæ­¥å¤±è´¥: ' + error.message;
                syncStatus.className = 'sync-status error';
            }
        }

        // ========== GitHubåŒæ­¥åŠŸèƒ½ ==========

        async function syncToGitHub(data) {
            if (!storageConfig.github.token) {
                throw new Error('è¯·å…ˆé…ç½®GitHub Token');
            }
            
            const gistId = storageConfig.github.gistId;
            const gistData = {
                description: 'OKXèµ„äº§ç›‘æ§æ•°æ®',
                public: false,
                files: {
                    'okx-data.json': {
                        content: JSON.stringify({
                            ...data,
                            syncTime: new Date().toISOString(),
                            version: '2.2'
                        })
                    }
                }
            };
            
            const url = gistId ? 
                `https://api.github.com/gists/${gistId}` :
                'https://api.github.com/gists';
            
            const method = gistId ? 'PATCH' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `token ${storageConfig.github.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistData)
            });
            
            if (!response.ok) {
                throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
            }
            
            const result = await response.json();
            
            // ä¿å­˜Gist ID
            if (!gistId) {
                storageConfig.github.gistId = result.id;
                localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
            }
            
            return result;
        }

        async function loadFromGitHub() {
            if (!storageConfig.github.token || !storageConfig.github.gistId) {
                throw new Error('GitHubé…ç½®ä¸å®Œæ•´');
            }
            
            const response = await fetch(`https://api.github.com/gists/${storageConfig.github.gistId}`, {
                headers: {
                    'Authorization': `token ${storageConfig.github.token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status}`);
            }
            
            const gist = await response.json();
            const content = JSON.parse(gist.files['okx-data.json'].content);
            
            // æ¢å¤åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('okxHistoricalData', JSON.stringify(content.historicalData));
            localStorage.setItem('okxHourlyData', JSON.stringify(content.hourlyData));
            
            return content;
        }

        // ========== æœåŠ¡å™¨åŒæ­¥åŠŸèƒ½ ==========

        async function syncToServer(data) {
            if (!storageConfig.server.url || !storageConfig.server.token) {
                throw new Error('æœåŠ¡å™¨é…ç½®ä¸å®Œæ•´');
            }
            
            const response = await fetch(`${storageConfig.server.url}/api/sync-data`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${storageConfig.server.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: data,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
            }
            
            return await response.json();
        }

        async function loadFromServer() {
            if (!storageConfig.server.url || !storageConfig.server.token) {
                throw new Error('æœåŠ¡å™¨é…ç½®ä¸å®Œæ•´');
            }
            
            const response = await fetch(`${storageConfig.server.url}/api/get-data`, {
                headers: {
                    'Authorization': `Bearer ${storageConfig.server.token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status}`);
            }
            
            const data = await response.json();
            
            // æ¢å¤åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('okxHistoricalData', JSON.stringify(data.historicalData));
            localStorage.setItem('okxHourlyData', JSON.stringify(data.hourlyData));
            
            return data;
        }

        // ========== æ•°æ®ç®¡ç†åŠŸèƒ½ ==========

        function updateDataStats() {
            const historicalData = JSON.parse(localStorage.getItem('okxHistoricalData') || '{}');
            const hourlyData = JSON.parse(localStorage.getItem('okxHourlyData') || '[]');
            
            const dataPoints = Object.keys(historicalData).length + hourlyData.length;
            document.getElementById('data-points').textContent = dataPoints;
            
            // è®¡ç®—å¼€å§‹æ—¶é—´
            let startTime = '--';
            if (hourlyData.length > 0) {
                const firstPoint = new Date(hourlyData[0].timestamp);
                startTime = firstPoint.toLocaleDateString('zh-CN');
            }
            document.getElementById('data-start').textContent = startTime;
        }

        async function exportAllData() {
            const historicalData = JSON.parse(localStorage.getItem('okxHistoricalData') || '{}');
            const hourlyData = JSON.parse(localStorage.getItem('okxHourlyData') || '[]');
            const priceAlerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
            
            const exportData = {
                version: '2.2',
                exportTime: new Date().toISOString(),
                historicalData,
                hourlyData,
                priceAlerts,
                storageConfig
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `okx-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showStatus('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚')) {
                        localStorage.setItem('okxHistoricalData', JSON.stringify(importData.historicalData || {}));
                        localStorage.setItem('okxHourlyData', JSON.stringify(importData.hourlyData || []));
                        localStorage.setItem('priceAlerts', JSON.stringify(importData.priceAlerts || {}));
                        
                        if (importData.storageConfig) {
                            localStorage.setItem('storageConfig', JSON.stringify(importData.storageConfig));
                            storageConfig = importData.storageConfig;
                            updateStorageUI();
                        }
                        
                        updateDataStats();
                        showStatus('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                    }
                } catch (error) {
                    showStatus('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                }
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('okxHistoricalData');
                localStorage.removeItem('okxHourlyData');
                localStorage.removeItem('priceAlerts');
                updateDataStats();
                showStatus('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
            }
        }

        // ========== é…ç½®ä¿å­˜å‡½æ•° ==========

        function saveGitHubConfig() {
            const token = document.getElementById('github-token').value.trim();
            const gistId = document.getElementById('github-gist').value.trim();
            
            if (!token) {
                showStatus('è¯·è¾“å…¥GitHub Token', 'error');
                return;
            }
            
            storageConfig.github.token = token;
            storageConfig.github.gistId = gistId || '';
            localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
            
            showStatus('GitHubé…ç½®å·²ä¿å­˜', 'success');
        }

        function saveServerConfig() {
            const url = document.getElementById('server-url').value.trim();
            const token = document.getElementById('server-token').value.trim();
            
            if (!url || !token) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„æœåŠ¡å™¨é…ç½®', 'error');
                return;
            }
            
            storageConfig.server.url = url;
            storageConfig.server.token = token;
            localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
            
            showStatus('æœåŠ¡å™¨é…ç½®å·²ä¿å­˜', 'success');
        }

        // ========== åˆå§‹åŒ–å‡½æ•° ==========

        function initStorage() {
            loadStorageConfig();
            updateDataStats();
            
            // ç»‘å®šå­˜å‚¨é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.storage-option').forEach(option => {
                option.addEventListener('click', () => {
                    storageConfig.type = option.dataset.storage;
                    localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
                    updateStorageUI();
                });
            });
            
            // åˆå§‹åŒ–GitHubé…ç½®æ˜¾ç¤º
            document.getElementById('github-token').value = storageConfig.github.token;
            document.getElementById('github-gist').value = storageConfig.github.gistId;
            document.getElementById('server-url').value = storageConfig.server.url;
            document.getElementById('server-token').value = storageConfig.server.token;
            
            // åº”ç”¨å¯åŠ¨æ—¶å°è¯•ä»äº‘ç«¯åŠ è½½æ•°æ®
            if (storageConfig.type !== 'local') {
                setTimeout(() => {
                    loadFromCloud();
                }, 1000);
            }
        }

        async function loadFromCloud() {
            try {
                if (storageConfig.type === 'github') {
                    await loadFromGitHub();
                } else if (storageConfig.type === 'server') {
                    await loadFromServer();
                }
                updateDataStats();
                showStatus('äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                console.log('äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥:', error.message);
            }
        }

        // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°
        function init() {
            // åŸæœ‰çš„åˆå§‹åŒ–ä»£ç ...
            initStorage();
            // å…¶ä»–åˆå§‹åŒ–...
        }

        // åŸæœ‰çš„å…¶ä»–å‡½æ•°ä¿æŒä¸å˜...
    </script>
</body>
</html>
