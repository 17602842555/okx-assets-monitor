<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX资产监控 v2.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <style>
        :root {
            --bg-primary: #0d1421;
            --bg-secondary: #1a2235;
            --bg-tertiary: #232c41;
            --text-primary: #eaecef;
            --text-secondary: #8a94a6;
            --accent-color: #00d2d3;
            --positive-color: #00c087;
            --negative-color: #ff5b5a;
            --border-color: #2a3345;
        }
        .light-theme {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --accent-color: #00d2d3;
            --positive-color: #00c087;
            --negative-color: #ff5b5a;
            --border-color: #e1e5e9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-primary); color: var(--text-primary); padding: 20px; min-height: 100vh; transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        h1 { font-size: 24px; font-weight: 600; color: var(--accent-color); }
        .last-update { color: var(--text-secondary); font-size: 14px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .card-title { font-size: 16px; color: var(--text-secondary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .total-assets { font-size: 32px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; }
        .unit-toggle, .refresh-btn, .save-btn, .clear-btn, .theme-toggle, .show-api-btn, .alert-btn { 
            padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 12px; 
            border: 1px solid var(--accent-color); background: transparent; color: var(--accent-color);
            margin: 2px;
        }
        .refresh-btn, .save-btn { background: var(--accent-color); color: var(--bg-primary); border: none; }
        .clear-btn { border-color: var(--negative-color); color: var(--negative-color); }
        .alert-btn { background: var(--negative-color); color: white; border: none; padding: 5px 10px; }
        .change { display: flex; align-items: center; font-size: 14px; margin-bottom: 10px; }
        .positive { color: var(--positive-color); }
        .negative { color: var(--negative-color); }
        .chart-container { height: 300px; margin-top: 15px; }
        .trend-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .trend-btn { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .trend-btn.active { background: var(--accent-color); color: var(--bg-primary); border-color: var(--accent-color); }
        .assets-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .asset-item { display: flex; justify-content: space-between; padding: 12px 15px; background: var(--bg-tertiary); border-radius: 8px; }
        .asset-name { display: flex; align-items: center; }
        .asset-icon { width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .api-config { display: block; } /* 默认显示 */
        .api-config.hidden { display: none; } /* 隐藏状态 */
        .api-input-group { margin-bottom: 15px; }
        .api-input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); }
        .api-input-group input, .api-input-group select { width: 100%; padding: 10px 15px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); }
        .api-actions { display: flex; gap: 10px; margin-top: 15px; }
        .status { margin-top: 15px; padding: 10px; border-radius: 6px; font-size: 14px; }
        .status.success { background: rgba(0, 192, 135, 0.1); color: var(--positive-color); }
        .status.error { background: rgba(255, 91, 90, 0.1); color: var(--negative-color); }
        .no-data { text-align: center; color: var(--text-secondary); padding: 40px 20px; font-style: italic; }
        .positions-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .positions-table th, .positions-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .positions-table th { color: var(--text-secondary); font-weight: 600; font-size: 14px; }
        .position-direction { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 5px; }
        .long { background: rgba(0, 192, 135, 0.2); color: var(--positive-color); }
        .short { background: rgba(255, 91, 90, 0.2); color: var(--negative-color); }
        .alert-input-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .alert-input-group input { flex: 1; padding: 5px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px; }
        .alerts-list { font-size: 11px; }
        .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 3px 5px; background: var(--bg-tertiary); border-radius: 3px; margin-bottom: 2px; }
        .remove-alert { background: transparent; color: var(--negative-color); border: none; cursor: pointer; font-size: 12px; }
        .settings-panel { margin-top: 15px; padding: 15px; background: rgba(42, 51, 69, 0.3); border-radius: 8px; }
        .light-theme .settings-panel { background: rgba(225, 229, 233, 0.3); }
        .settings-group { margin-bottom: 15px; }
        .github-config { margin-top: 10px; padding: 10px; background: rgba(42, 51, 69, 0.5); border-radius: 6px; }
        .light-theme .github-config { background: rgba(225, 229, 233, 0.5); }
        .collapsible { cursor: pointer; user-select: none; }
        .collapsible::after { content: '▼'; font-size: 12px; margin-left: 10px; transition: transform 0.3s ease; }
        .collapsible.collapsed::after { transform: rotate(-90deg); }
        .collapsible-content { overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.collapsed { max-height: 0; }
        
        /* 手机端响应式样式 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                overflow-x: auto;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            /* 表格容器水平滚动 */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .positions-table {
                min-width: 800px;
            }
            
            /* 资产详情网格调整 */
            .assets-breakdown {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            /* 按钮组调整 */
            .api-actions, .trend-controls {
                flex-wrap: wrap;
            }
            
            .refresh-btn, .unit-toggle, .show-api-btn {
                font-size: 11px;
                padding: 6px 10px;
            }
            
            /* 总资产显示调整 */
            .total-assets {
                font-size: 24px;
                flex-wrap: wrap;
            }
            
            /* GitHub按钮调整 */
            .github-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center;">
                <h1>OKX资产监控 v2.5</h1>
                <button class="theme-toggle" onclick="App.toggleTheme()">浅色模式</button>
            </div>
            <div class="last-update">最后更新: <span id="update-time">--:--:--</span></div>
        </header>
        
        <!-- 配置面板 - 默认显示，保存后隐藏 -->
        <div class="card api-config" id="api-config">
            <div class="card-title">API配置
                <button class="show-api-btn" onclick="App.hideApiConfig()">隐藏设置</button>
            </div>
            <div class="api-input-group">
                <label for="api-key">API Key</label>
                <input type="text" id="api-key" placeholder="请输入您的API Key">
            </div>
            <div class="api-input-group">
                <label for="secret-key">Secret Key</label>
                <input type="password" id="secret-key" placeholder="请输入您的Secret Key">
            </div>
            <div class="api-input-group">
                <label for="passphrase">Passphrase</label>
                <input type="password" id="passphrase" placeholder="请输入您的Passphrase">
            </div>

            <!-- GitHub同步配置 -->
            <div class="settings-panel">
                <div class="card-title">GitHub数据同步</div>
                <div class="github-config">
                    <input type="text" id="github-token" placeholder="GitHub Personal Access Token">
                    <input type="text" id="github-gist" placeholder="Gist ID (留空自动创建)">
                    <button class="save-btn" onclick="App.saveGitHubConfig()" style="width: 100%; margin-top: 10px;">保存GitHub配置</button>
                    
                    <!-- 同步操作按钮 -->
                    <div class="github-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="save-btn" onclick="App.manualSync()" style="flex: 1;">立即同步到GitHub</button>
                        <button class="refresh-btn" onclick="App.manualRestore()" style="flex: 1;">从GitHub恢复</button>
                    </div>
                </div>
                <div class="sync-status" id="sync-status" style="margin-top: 10px; font-size: 12px;"></div>
            </div>
            
            <!-- 系统设置面板 -->
            <div class="settings-panel">
                <div class="card-title">系统设置</div>
                
                <div class="settings-group">
                    <label for="language-select">语言设置</label>
                    <select id="language-select" onchange="App.changeLanguage(this.value)">
                        <option value="zh-CN">简体中文</option>
                        <option value="en-US">English</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label for="alert-sound-select">提醒铃声</label>
                    <select id="alert-sound-select" onchange="App.changeAlertSound(this.value)">
                        <option value="beep">默认提示音</option>
                        <option value="bell">铃铛声</option>
                        <option value="chime">钟声</option>
                        <option value="digital">数字音</option>
                        <option value="none">无声音</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label for="refresh-interval">自动刷新间隔</label>
                    <select id="refresh-interval" onchange="App.changeRefreshInterval(this.value)">
                        <option value="2000">2秒</option>
                        <option value="5000">5秒</option>
                        <option value="10000">10秒</option>
                        <option value="30000">30秒</option>
                        <option value="60000">1分钟</option>
                        <option value="300000">5分钟</option>
                        <option value="0">关闭自动刷新</option>
                    </select>
                </div>
            </div>
            
            <div class="api-actions">
                <button class="save-btn" onclick="App.saveApiConfig()">保存配置</button>
                <button class="clear-btn" onclick="App.clearApiConfig()">清除配置</button>
            </div>
            <div id="api-status" class="status"></div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-title">总资产概览
                    <button class="show-api-btn" onclick="App.showApiConfig()">显示设置</button>
                </div>
                <div class="total-assets" id="total-assets">
                    $ --
                    <button class="unit-toggle" onclick="App.toggleUnit()">切换单位</button>
                </div>
                <div class="change" id="change-display">
                    <span id="change-text">24小时变化</span>: --
                </div>
                <div style="margin-top: 15px;">
                    <button class="refresh-btn" onclick="App.refreshData()">刷新数据</button>
                    <button class="refresh-btn" onclick="App.toggleAutoRefresh()" id="auto-refresh-toggle">开启自动刷新</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">资产分布</div>
                <div class="chart-container">
                    <canvas id="distribution-chart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">资产趋势
                    <div class="trend-controls">
                        <button class="trend-btn active" onclick="App.setTrendPeriod('24h')">24H</button>
                        <button class="trend-btn" onclick="App.setTrendPeriod('7d')">7D</button>
                        <button class="trend-btn" onclick="App.setTrendPeriod('30d')">1M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 资产详情 -->
        <div class="card">
            <div class="card-title collapsible" id="assets-detail-title" onclick="App.toggleAssetsDetail()">
                资产详情
            </div>
            <div class="collapsible-content" id="assets-detail-content">
                <div class="assets-breakdown" id="assets-breakdown">
                    <div class="no-data">请配置API并刷新数据</div>
                </div>
            </div>
        </div>

        <!-- 持仓详情 -->
        <div class="card">
            <div class="card-title">持仓详情</div>
            <div class="table-container">
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>合约</th>
                            <th>方向</th>
                            <th>持仓量</th>
                            <th>标记价格</th>
                            <th>开仓价格</th>
                            <th>强平价格</th>
                            <th>浮动收益</th>
                            <th>收益率</th>
                            <th>价格提醒</th>
                        </tr>
                    </thead>
                    <tbody id="positions-body">
                        <tr>
                            <td colspan="9" class="no-data">请配置API并刷新数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const App = {
            // 配置和数据
            config: {
                system: {
                    language: 'zh-CN',
                    alertSound: 'beep',
                    refreshInterval: 30000,
                    autoRefresh: false,
                    theme: 'dark',
                    assetsDetailCollapsed: false,
                    apiConfigHidden: false // 新增：控制配置面板显示状态
                },
                api: { apiKey: '', secretKey: '', passphrase: '' },
                github: { token: '', gistId: '' }
            },
            
            data: {
                assets: { total: 0, change24h: 0, change7d: 0, change30d: 0, breakdown: [], positions: [] },
                historical: [],
                exchangeRates: { USDCNY: 7.2, USDBTC: 0.00002 },
                priceAlerts: {},
                currentUnit: 'USD',
                currentTrendPeriod: '24h',
                isUpdating: false,
                autoRefreshInterval: null,
                lastDataSaveTime: 0
            },

            // 多语言文本
            translations: {
                'zh-CN': {
                    'appTitle': 'OKX资产监控 v2.5',
                    'lastUpdate': '最后更新',
                    'totalAssets': '总资产概览',
                    'distribution': '资产分布',
                    'trend': '资产趋势',
                    'assetsDetail': '资产详情',
                    'positions': '持仓详情',
                    'change24h': '24小时变化',
                    'change7d': '7天变化',
                    'change30d': '1月变化',
                    'noAssetsData': '请配置API并刷新数据',
                    'noPositionsData': '请配置API并刷新数据',
                    'showSettings': '显示设置',
                    'hideSettings': '隐藏设置',
                    'refreshData': '刷新数据',
                    'autoRefresh': '开启自动刷新',
                    'stopAutoRefresh': '关闭自动刷新',
                    'lightTheme': '浅色模式',
                    'darkTheme': '深色模式'
                },
                'en-US': {
                    'appTitle': 'OKX Asset Monitor v2.5',
                    'lastUpdate': 'Last Update',
                    'totalAssets': 'Total Assets',
                    'distribution': 'Asset Distribution',
                    'trend': 'Asset Trend',
                    'assetsDetail': 'Asset Details',
                    'positions': 'Position Details',
                    'change24h': '24H Change',
                    'change7d': '7D Change',
                    'change30d': '1M Change',
                    'noAssetsData': 'Please configure API and refresh data',
                    'noPositionsData': 'Please configure API and refresh data',
                    'showSettings': 'Show Settings',
                    'hideSettings': 'Hide Settings',
                    'refreshData': 'Refresh Data',
                    'autoRefresh': 'Enable Auto Refresh',
                    'stopAutoRefresh': 'Disable Auto Refresh',
                    'lightTheme': 'Light Mode',
                    'darkTheme': 'Dark Mode'
                }
            },

            // 初始化应用
            init() {
                console.log('初始化应用...');
                this.loadAllConfig();
                this.initCharts();
                this.updateUI();
                this.fetchExchangeRates();
                
                // 如果已有API配置，自动隐藏配置面板
                if (this.config.api.apiKey && this.config.system.apiConfigHidden) {
                    this.hideApiConfig();
                }
                
                console.log('应用初始化完成');
            },

            // 加载所有配置
            loadAllConfig() {
                // 加载系统配置
                const savedSystem = localStorage.getItem('systemConfig');
                if (savedSystem) {
                    const systemConfig = JSON.parse(savedSystem);
                    this.config.system = { ...this.config.system, ...systemConfig };
                }

                // 加载API配置
                const savedApi = localStorage.getItem('okxApiConfig');
                if (savedApi) {
                    this.config.api = JSON.parse(savedApi);
                }

                // 加载GitHub配置
                const savedGithub = localStorage.getItem('githubConfig');
                if (savedGithub) {
                    this.config.github = JSON.parse(savedGithub);
                }

                // 加载价格提醒
                const savedAlerts = localStorage.getItem('priceAlerts');
                if (savedAlerts) {
                    this.data.priceAlerts = JSON.parse(savedAlerts);
                }

                // 加载历史数据 - 修复数据同步问题
                const savedHistorical = localStorage.getItem('okxHistoricalData');
                if (savedHistorical) {
                    try {
                        this.data.historical = JSON.parse(savedHistorical);
                        console.log('加载历史数据:', this.data.historical.length, '条记录');
                    } catch (e) {
                        console.error('历史数据加载失败:', e);
                        this.data.historical = [];
                    }
                }

                // 更新表单值
                document.getElementById('api-key').value = this.config.api.apiKey || '';
                document.getElementById('secret-key').value = this.config.api.secretKey || '';
                document.getElementById('passphrase').value = this.config.api.passphrase || '';
                document.getElementById('github-token').value = this.config.github.token || '';
                document.getElementById('github-gist').value = this.config.github.gistId || '';
                document.getElementById('language-select').value = this.config.system.language;
                document.getElementById('alert-sound-select').value = this.config.system.alertSound;
                document.getElementById('refresh-interval').value = this.config.system.refreshInterval;

                // 更新自动刷新
                if (this.config.system.autoRefresh && this.config.system.refreshInterval > 0) {
                    this.startAutoRefresh();
                }
            },

            // 初始化图表
            initCharts() {
                const distributionCtx = document.getElementById('distribution-chart').getContext('2d');
                this.distributionChart = new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#00d2d3', '#00c087', '#ff5b5a', '#ffc542', '#8a94a6'] }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const trendCtx = document.getElementById('trend-chart').getContext('2d');
                this.trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#00d2d3', backgroundColor: 'rgba(0, 210, 211, 0.1)', tension: 0.4, fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            },

            // 更新界面
            updateUI() {
                this.updateTheme();
                this.updateLanguage();
                this.updateCollapsible();
                this.updateTime();
                this.updateTrendChart();
                this.updateAutoRefreshButton();
                this.updateApiConfigButton();
            },

            // === 配置面板控制 ===
            showApiConfig() {
                console.log('显示API配置');
                document.getElementById('api-config').classList.remove('hidden');
                this.config.system.apiConfigHidden = false;
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
                this.updateApiConfigButton();
            },

            hideApiConfig() {
                console.log('隐藏API配置');
                document.getElementById('api-config').classList.add('hidden');
                this.config.system.apiConfigHidden = true;
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
                this.updateApiConfigButton();
            },

            updateApiConfigButton() {
                const texts = this.translations[this.config.system.language];
                const showBtn = document.querySelector('.show-api-btn');
                const hideBtn = document.querySelector('#api-config .show-api-btn');
                
                if (showBtn) {
                    showBtn.textContent = texts.showSettings;
                }
                if (hideBtn) {
                    hideBtn.textContent = texts.hideSettings;
                }
            },

            // === 核心功能方法 ===

            // 保存API配置
            saveApiConfig() {
                console.log('保存API配置');
                const apiKey = document.getElementById('api-key').value.trim();
                const secretKey = document.getElementById('secret-key').value.trim();
                const passphrase = document.getElementById('passphrase').value.trim();
                
                if (!apiKey || !secretKey || !passphrase) {
                    this.showStatus('请填写完整的API配置信息', 'error');
                    return;
                }
                
                this.config.api = { apiKey, secretKey, passphrase };
                localStorage.setItem('okxApiConfig', JSON.stringify(this.config.api));
                this.showStatus('API配置已保存', 'success');
                
                // 保存配置后自动隐藏面板
                this.hideApiConfig();
                
                // 自动刷新数据
                this.refreshData();
            },

            // 清除API配置
            clearApiConfig() {
                console.log('清除API配置');
                document.getElementById('api-key').value = '';
                document.getElementById('secret-key').value = '';
                document.getElementById('passphrase').value = '';
                this.config.api = { apiKey: '', secretKey: '', passphrase: '' };
                localStorage.removeItem('okxApiConfig');
                this.showStatus('API配置已清除', 'success');
                
                // 清除配置后显示面板
                this.showApiConfig();
            },

            // 保存GitHub配置
            async saveGitHubConfig() {
                console.log('保存GitHub配置');
                const token = document.getElementById('github-token').value.trim();
                const gistId = document.getElementById('github-gist').value.trim();
                
                if (!token) {
                    this.showStatus('请输入GitHub Token', 'error');
                    return;
                }
                
                this.config.github = { token, gistId };
                localStorage.setItem('githubConfig', JSON.stringify(this.config.github));
                this.showStatus('GitHub配置已保存', 'success');
                
                // 自动测试连接
                await this.testGitHubConnection();
            },

            // 测试GitHub连接
            async testGitHubConnection() {
                if (!this.config.github.token) return;
                
                try {
                    const syncStatus = document.getElementById('sync-status');
                    syncStatus.textContent = '测试GitHub连接...';
                    syncStatus.className = 'sync-status syncing';
                    
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${this.config.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`GitHub连接失败: ${response.status}`);
                    }
                    
                    const userData = await response.json();
                    syncStatus.textContent = `连接成功 (${userData.login})`;
                    syncStatus.className = 'sync-status success';
                    
                } catch (error) {
                    console.error('GitHub连接测试失败:', error);
                    const syncStatus = document.getElementById('sync-status');
                    syncStatus.textContent = '连接失败: ' + error.message;
                    syncStatus.className = 'sync-status error';
                }
            },

            // GitHub同步
            async syncToGitHub() {
                if (!this.config.github.token) {
                    this.showStatus('请先配置GitHub Token', 'error');
                    return;
                }
                
                try {
                    const syncStatus = document.getElementById('sync-status');
                    syncStatus.textContent = '正在同步数据到GitHub...';
                    syncStatus.className = 'sync-status syncing';
                    
                    // 准备同步数据
                    const dataToSync = {
                        historicalData: this.data.historical,
                        priceAlerts: this.data.priceAlerts,
                        assetsData: this.data.assets,
                        systemConfig: this.config.system,
                        exchangeRates: this.data.exchangeRates,
                        syncTime: new Date().toISOString(),
                        version: '2.5',
                        totalRecords: this.data.historical.length
                    };
                    
                    const gistId = this.config.github.gistId;
                    const gistData = {
                        description: `OKX资产监控数据 - ${new Date().toLocaleString('zh-CN')}`,
                        public: false,
                        files: {
                            'okx-asset-monitor-data.json': {
                                content: JSON.stringify(dataToSync, null, 2)
                            }
                        }
                    };
                    
                    const url = gistId ? 
                        `https://api.github.com/gists/${gistId}` :
                        'https://api.github.com/gists';
                    
                    const method = gistId ? 'PATCH' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `token ${this.config.github.token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`GitHub API错误: ${response.status} - ${errorData.message}`);
                    }
                    
                    const result = await response.json();
                    
                    // 如果是新创建的Gist，保存Gist ID
                    if (!gistId) {
                        this.config.github.gistId = result.id;
                        localStorage.setItem('githubConfig', JSON.stringify(this.config.github));
                        document.getElementById('github-gist').value = result.id;
                    }
                    
                    syncStatus.textContent = `同步成功! Gist: ${result.id}`;
                    syncStatus.className = 'sync-status success';
                    
                } catch (error) {
                    console.error('GitHub同步失败:', error);
                    const syncStatus = document.getElementById('sync-status');
                    syncStatus.textContent = '同步失败: ' + error.message;
                    syncStatus.className = 'sync-status error';
                    this.showStatus('GitHub同步失败: ' + error.message, 'error');
                }
            },

            // 从GitHub加载数据
            async loadFromGitHub() {
                if (!this.config.github.token || !this.config.github.gistId) {
                    throw new Error('GitHub配置不完整，请检查Token和Gist ID');
                }
                
                try {
                    const syncStatus = document.getElementById('sync-status');
                    syncStatus.textContent = '正在从GitHub恢复数据...';
                    syncStatus.className = 'sync-status syncing';
                    
                    const response = await fetch(`https://api.github.com/gists/${this.config.github.gistId}`, {
                        headers: {
                            'Authorization': `token ${this.config.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`获取数据失败: ${response.status}`);
                    }
                    
                    const gist = await response.json();
                    const fileContent = gist.files['okx-asset-monitor-data.json'] || gist.files['okx-data.json'];
                    
                    if (!fileContent) {
                        throw new Error('Gist中未找到有效数据文件');
                    }
                    
                    const content = JSON.parse(fileContent.content);
                    
                    // 恢复数据
                    if (content.historicalData) {
                        this.data.historical = content.historicalData;
                        localStorage.setItem('okxHistoricalData', JSON.stringify(this.data.historical));
                    }
                    if (content.priceAlerts) {
                        this.data.priceAlerts = content.priceAlerts;
                        localStorage.setItem('priceAlerts', JSON.stringify(this.data.priceAlerts));
                    }
                    if (content.assetsData) {
                        this.data.assets = { ...this.data.assets, ...content.assetsData };
                    }
                    
                    syncStatus.textContent = `数据恢复成功! 加载了 ${content.historicalData?.length || 0} 条历史记录`;
                    syncStatus.className = 'sync-status success';
                    
                    // 更新界面
                    this.updateTrendChart();
                    this.showStatus('云端数据恢复成功', 'success');
                    
                } catch (error) {
                    console.error('GitHub数据恢复失败:', error);
                    const syncStatus = document.getElementById('sync-status');
                    syncStatus.textContent = '恢复失败: ' + error.message;
                    syncStatus.className = 'sync-status error';
                    throw error;
                }
            },

            // 手动同步
            async manualSync() {
                await this.syncToGitHub();
            },

            // 手动恢复
            async manualRestore() {
                await this.loadFromGitHub();
            },

            // 切换主题
            toggleTheme() {
                console.log('切换主题');
                this.config.system.theme = this.config.system.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
                this.updateTheme();
            },

            // 更新主题
            updateTheme() {
                if (this.config.system.theme === 'light') {
                    document.body.classList.add('light-theme');
                    document.querySelector('.theme-toggle').textContent = this.translations[this.config.system.language].darkTheme;
                } else {
                    document.body.classList.remove('light-theme');
                    document.querySelector('.theme-toggle').textContent = this.translations[this.config.system.language].lightTheme;
                }
            },

            // 切换语言
            changeLanguage(lang) {
                console.log('切换语言:', lang);
                this.config.system.language = lang;
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
                this.updateLanguage();
            },

            // 更新语言
            updateLanguage() {
                const texts = this.translations[this.config.system.language];
                document.querySelector('h1').textContent = texts.appTitle;
                document.querySelector('.last-update').innerHTML = `${texts.lastUpdate}: <span id="update-time">--:--:--</span>`;
                document.querySelector('#total-assets-title').innerHTML = `${texts.totalAssets} <button class="show-api-btn" onclick="App.showApiConfig()">${texts.showSettings}</button>`;
                document.querySelector('#distribution-title').textContent = texts.distribution;
                document.querySelector('#trend-title').textContent = texts.trend;
                document.querySelector('#assets-detail-title').textContent = texts.assetsDetail;
                document.querySelector('#positions-title').textContent = texts.positions;
                document.querySelector('.refresh-btn').textContent = texts.refreshData;
                this.updateChangeText();
                this.updateAutoRefreshButton();
                this.updateApiConfigButton();
            },

            // 切换提醒声音
            changeAlertSound(sound) {
                console.log('切换提醒声音:', sound);
                this.config.system.alertSound = sound;
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
            },

            // 切换刷新间隔
            changeRefreshInterval(interval) {
                console.log('切换刷新间隔:', interval);
                this.config.system.refreshInterval = parseInt(interval);
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
                
                if (this.config.system.autoRefresh) {
                    this.stopAutoRefresh();
                    this.startAutoRefresh();
                }
            },

            // 切换单位
            toggleUnit() {
                console.log('切换单位');
                const units = ['USD', 'CNY', 'BTC'];
                this.data.currentUnit = units[(units.indexOf(this.data.currentUnit) + 1) % units.length];
                this.updateTotalAssetsDisplay();
                this.updateAssetsBreakdown();
                this.updatePositions();
            },

            // 切换资产详情折叠
            toggleAssetsDetail() {
                console.log('切换资产详情折叠');
                this.config.system.assetsDetailCollapsed = !this.config.system.assetsDetailCollapsed;
                localStorage.setItem('systemConfig', JSON.stringify(this.config.system));
                this.updateCollapsible();
            },

            // 更新折叠状态
            updateCollapsible() {
                const content = document.getElementById('assets-detail-content');
                const title = document.getElementById('assets-detail-title');
                
                if (this.config.system.assetsDetailCollapsed) {
                    content.classList.add('collapsed');
                    title.classList.add('collapsed');
                } else {
                    content.classList.remove('collapsed');
                    title.classList.remove('collapsed');
                }
            },

            // 切换自动刷新
            toggleAutoRefresh() {
                console.log('切换自动刷新');
                if (this.config.system.autoRefresh) {
                    this.stopAutoRefresh();
                } else {
                    this.startAutoRefresh();
                }
            },

            // 开始自动刷新
            startAutoRefresh() {
                this.stopAutoRefresh();
                if (this.config.system.refreshInterval > 0) {
                    this.data.autoRefreshInterval = setInterval(() => this.refreshData(), this.config.system.refreshInterval);
                    this.config.system.autoRefresh = true;
                    this.updateAutoRefreshButton();
                }
            },

            // 停止自动刷新
            stopAutoRefresh() {
                if (this.data.autoRefreshInterval) {
                    clearInterval(this.data.autoRefreshInterval);
                    this.data.autoRefreshInterval = null;
                }
                this.config.system.autoRefresh = false;
                this.updateAutoRefreshButton();
            },

            // 更新自动刷新按钮
            updateAutoRefreshButton() {
                const btn = document.getElementById('auto-refresh-toggle');
                if (btn) {
                    const texts = this.translations[this.config.system.language];
                    btn.textContent = this.config.system.autoRefresh ? texts.stopAutoRefresh : texts.autoRefresh;
                }
            },

            // 设置趋势周期
            setTrendPeriod(period) {
                console.log('设置趋势周期:', period);
                this.data.currentTrendPeriod = period;
                document.querySelectorAll('.trend-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                this.updateChangeText();
                this.updateTrendChart();
            },

            // 刷新数据
            async refreshData() {
                console.log('刷新数据');
                if (!this.config.api.apiKey || !this.config.api.secretKey || !this.config.api.passphrase) {
                    this.showStatus('请先配置API信息', 'error');
                    return;
                }
                
                if (this.data.isUpdating) return;
                
                this.data.isUpdating = true;
                const refreshBtn = document.querySelector('.refresh-btn');
                if (refreshBtn) refreshBtn.disabled = true;
                
                try {
                    // 使用真实API调用
                    const [balances, positions] = await Promise.all([
                        this.fetchAccountBalance(),
                        this.fetchPositions()
                    ]);
                    
                    const processedData = this.processAssetData(balances);
                    if (processedData) {
                        this.data.assets = {
                            ...processedData,
                            positions: this.processPositionsData(positions)
                        };
                        
                        // 保存历史数据（15分钟间隔）
                        this.saveHistoricalData(this.data.assets.total);
                        
                        // 计算资产变化
                        this.calculateAssetChanges(this.data.assets.total);
                        
                        this.updateTotalAssetsDisplay();
                        this.updateAssetsBreakdown();
                        this.updatePositions();
                        this.updateCharts();
                        this.updateTime();
                        this.updateChangeDisplay();
                        this.checkPriceAlerts();
                        this.showStatus('数据更新成功', 'success');
                    } else {
                        this.showStatus('暂无资产数据', 'error');
                    }
                } catch (error) {
                    // 如果API调用失败，使用模拟数据
                    console.log('API调用失败，使用模拟数据:', error.message);
                    await this.useMockData();
                } finally {
                    this.data.isUpdating = false;
                    if (refreshBtn) refreshBtn.disabled = false;
                }
            },

            // 使用模拟数据（测试用）
            async useMockData() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const mockTotal = 10000 + Math.random() * 5000;
                        const mockData = {
                            total: mockTotal,
                            breakdown: [
                                { name: 'BTC', value: mockTotal * 0.5, percentage: 50 },
                                { name: 'ETH', value: mockTotal * 0.3, percentage: 30 },
                                { name: 'USDT', value: mockTotal * 0.2, percentage: 20 }
                            ],
                            positions: [
                                {
                                    instId: 'BTC-USDT',
                                    pos: 0.1,
                                    markPx: 45000,
                                    avgPx: 44000,
                                    liqPx: 38000,
                                    unrealizedPnl: 100,
                                    pnlPercent: 2.27,
                                    posSide: 'long'
                                }
                            ]
                        };
                        
                        this.data.assets = { ...this.data.assets, ...mockData };
                        this.saveHistoricalData(this.data.assets.total);
                        this.calculateAssetChanges(this.data.assets.total);
                        this.updateTotalAssetsDisplay();
                        this.updateAssetsBreakdown();
                        this.updatePositions();
                        this.updateCharts();
                        this.updateTime();
                        this.updateChangeDisplay();
                        this.showStatus('模拟数据加载成功', 'success');
                        resolve();
                    }, 1000);
                });
            },

            // === API相关方法 ===
            generateSignature(timestamp, method, requestPath, body = '') {
                const message = timestamp + method + requestPath + body;
                return CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA256(message, this.config.api.secretKey));
            },

            async fetchAccountBalance() {
                if (!this.config.api.apiKey) throw new Error('请先配置API信息');

                const method = 'GET';
                const requestPath = '/api/v5/account/balance';
                const timestamp = new Date().toISOString();
                const signature = this.generateSignature(timestamp, method, requestPath);

                const response = await fetch(`https://www.okx.com${requestPath}`, {
                    method: method,
                    headers: {
                        'OK-ACCESS-KEY': this.config.api.apiKey,
                        'OK-ACCESS-SIGN': signature,
                        'OK-ACCESS-TIMESTAMP': timestamp,
                        'OK-ACCESS-PASSPHRASE': this.config.api.passphrase,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`API请求失败: ${response.status}`);
                const data = await response.json();
                if (data.code !== '0') throw new Error(`API错误: ${data.msg}`);
                return data.data[0].details;
            },

            async fetchPositions() {
                if (!this.config.api.apiKey) throw new Error('请先配置API信息');

                const method = 'GET';
                const requestPath = '/api/v5/account/positions';
                const timestamp = new Date().toISOString();
                const signature = this.generateSignature(timestamp, method, requestPath);

                const response = await fetch(`https://www.okx.com${requestPath}`, {
                    method: method,
                    headers: {
                        'OK-ACCESS-KEY': this.config.api.apiKey,
                        'OK-ACCESS-SIGN': signature,
                        'OK-ACCESS-TIMESTAMP': timestamp,
                        'OK-ACCESS-PASSPHRASE': this.config.api.passphrase,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`API请求失败: ${response.status}`);
                const data = await response.json();
                if (data.code !== '0') throw new Error(`API错误: ${data.msg}`);
                return data.data;
            },

            processAssetData(balances) {
                if (!balances || balances.length === 0) return null;
                let total = 0;
                const breakdown = [];
                
                balances.forEach(asset => {
                    const value = parseFloat(asset.eq) || parseFloat(asset.cashBal) || 0;
                    if (value > 0) {
                        total += value;
                        breakdown.push({ name: asset.ccy, value: value, percentage: 0 });
                    }
                });
                
                breakdown.forEach(asset => {
                    asset.percentage = total > 0 ? (asset.value / total * 100).toFixed(1) : 0;
                });
                
                breakdown.sort((a, b) => b.value - a.value);
                return { total, breakdown };
            },

            processPositionsData(positions) {
                if (!positions || positions.length === 0) return [];
                return positions.filter(p => parseFloat(p.pos) > 0).map(position => ({
                    instId: position.instId,
                    pos: parseFloat(position.pos),
                    markPx: parseFloat(position.markPx) || 0,
                    avgPx: parseFloat(position.avgPx) || 0,
                    liqPx: parseFloat(position.liqPx) || 0,
                    unrealizedPnl: parseFloat(position.upl) || 0,
                    pnlPercent: (parseFloat(position.uplRatio) || 0) * 100,
                    posSide: position.posSide || 'long'
                }));
            },

            // === 数据管理方法 ===

            // 保存历史数据（15分钟间隔）
            saveHistoricalData(total) {
                const now = Date.now();
                
                // 检查是否达到15分钟间隔
                if (now - this.data.lastDataSaveTime < 15 * 60 * 1000 && this.data.historical.length > 0) {
                    return;
                }
                
                const dataPoint = {
                    timestamp: now,
                    total: total,
                    time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                };
                
                this.data.historical.push(dataPoint);
                this.data.lastDataSaveTime = now;
                
                // 保留最近1000个数据点
                if (this.data.historical.length > 1000) {
                    this.data.historical = this.data.historical.slice(-1000);
                }
                
                localStorage.setItem('okxHistoricalData', JSON.stringify(this.data.historical));
                console.log('保存历史数据，当前记录数:', this.data.historical.length);
                
                // 如果有GitHub配置，自动同步
                if (this.config.github.token) {
                    this.syncToGitHub();
                }
            },

            // 计算资产变化
            calculateAssetChanges(currentTotal) {
                const now = Date.now();
                const oneDayAgo = now - 24 * 60 * 60 * 1000;
                const oneWeekAgo = now - 7 * 24 * 60 * 60 * 1000;
                const oneMonthAgo = now - 30 * 24 * 60 * 60 * 1000;
                
                let dayAgoValue = currentTotal;
                let weekAgoValue = currentTotal;
                let monthAgoValue = currentTotal;
                
                // 查找历史数据
                for (let i = this.data.historical.length - 1; i >= 0; i--) {
                    const data = this.data.historical[i];
                    if (data.timestamp <= oneDayAgo && dayAgoValue === currentTotal) {
                        dayAgoValue = data.total;
                    }
                    if (data.timestamp <= oneWeekAgo && weekAgoValue === currentTotal) {
                        weekAgoValue = data.total;
                    }
                    if (data.timestamp <= oneMonthAgo && monthAgoValue === currentTotal) {
                        monthAgoValue = data.total;
                    }
                    
                    if (dayAgoValue !== currentTotal && weekAgoValue !== currentTotal && monthAgoValue !== currentTotal) {
                        break;
                    }
                }
                
                this.data.assets.change24h = dayAgoValue > 0 ? ((currentTotal - dayAgoValue) / dayAgoValue * 100) : 0;
                this.data.assets.change7d = weekAgoValue > 0 ? ((currentTotal - weekAgoValue) / weekAgoValue * 100) : 0;
                this.data.assets.change30d = monthAgoValue > 0 ? ((currentTotal - monthAgoValue) / monthAgoValue * 100) : 0;
            },

            // === 界面更新方法 ===

            // 更新总资产显示
            updateTotalAssetsDisplay() {
                let displayValue = this.data.assets.total;
                let unitSymbol = '$';
                
                if (this.data.currentUnit !== 'USD') {
                    displayValue = this.convertToUnit(this.data.assets.total, this.data.currentUnit);
                    unitSymbol = this.getUnitSymbol(this.data.currentUnit);
                }
                
                const element = document.getElementById('total-assets');
                if (element) {
                    element.innerHTML = `${unitSymbol}${this.formatNumber(displayValue)} <button class="unit-toggle" onclick="App.toggleUnit()">切换单位</button>`;
                }
            },

            // 更新资产详情
            updateAssetsBreakdown() {
                const container = document.getElementById('assets-breakdown');
                if (!container) return;
                
                if (!this.data.assets.breakdown || this.data.assets.breakdown.length === 0) {
                    container.innerHTML = '<div class="no-data">暂无资产数据</div>';
                    return;
                }
                
                let html = '';
                this.data.assets.breakdown.forEach(asset => {
                    let displayValue = asset.value;
                    let unitSymbol = '$';
                    
                    if (this.data.currentUnit !== 'USD') {
                        displayValue = this.convertToUnit(asset.value, this.data.currentUnit);
                        unitSymbol = this.getUnitSymbol(this.data.currentUnit);
                    }
                    
                    html += `
                        <div class="asset-item">
                            <div class="asset-name">
                                <div class="asset-icon">${asset.name.substring(0, 2)}</div>
                                <span>${asset.name}</span>
                            </div>
                            <div>
                                <div>${unitSymbol}${this.formatNumber(displayValue)}</div>
                                <div style="color: var(--text-secondary); font-size: 12px;">${asset.percentage}%</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },

            // 更新持仓信息
            updatePositions() {
                const container = document.getElementById('positions-body');
                if (!container) return;
                
                if (!this.data.assets.positions || this.data.assets.positions.length === 0) {
                    container.innerHTML = '<tr><td colspan="9" class="no-data">暂无持仓数据</td></tr>';
                    return;
                }
                
                let html = '';
                this.data.assets.positions.forEach((position, index) => {
                    let displayPnl = position.unrealizedPnl;
                    let unitSymbol = '$';
                    
                    if (this.data.currentUnit !== 'USD') {
                        displayPnl = this.convertToUnit(position.unrealizedPnl, this.data.currentUnit);
                        unitSymbol = this.getUnitSymbol(this.data.currentUnit);
                    }
                    
                    const directionClass = position.posSide === 'long' ? 'long' : 'short';
                    const directionText = position.posSide === 'long' ? '多' : '空';
                    const alerts = this.data.priceAlerts[position.instId] || [];
                    
                    html += `
                        <tr>
                            <td>${position.instId}</td>
                            <td><span class="position-direction ${directionClass}">${directionText}</span></td>
                            <td>${this.formatNumber(position.pos, 4)}</td>
                            <td>${this.formatNumber(position.markPx, 4)}</td>
                            <td>${this.formatNumber(position.avgPx, 4)}</td>
                            <td>${position.liqPx > 0 ? this.formatNumber(position.liqPx, 4) : '--'}</td>
                            <td class="${position.unrealizedPnl >= 0 ? 'positive' : 'negative'}">
                                ${unitSymbol}${position.unrealizedPnl >= 0 ? '+' : ''}${this.formatNumber(displayPnl)}
                            </td>
                            <td class="${position.pnlPercent >= 0 ? 'positive' : 'negative'}">
                                ${position.pnlPercent >= 0 ? '+' : ''}${position.pnlPercent.toFixed(2)}%
                            </td>
                            <td>
                                <div class="alert-input-group">
                                    <input type="number" id="alert-price-${index}" placeholder="目标价格" step="0.0001">
                                    <button class="alert-btn" onclick="App.addAlert('${position.instId}', ${index})">设置</button>
                                </div>
                                <div class="alerts-list">
                                    ${alerts.map(alert => `
                                        <div class="alert-item">
                                            <span>${alert.price}</span>
                                            <button class="remove-alert" onclick="App.removeAlert('${position.instId}', ${alert.id})">×</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            },

            // 价格提醒功能
            addAlert(instId, index) {
                const input = document.getElementById(`alert-price-${index}`);
                const price = input.value;
                if (price) {
                    if (!this.data.priceAlerts[instId]) this.data.priceAlerts[instId] = [];
                    this.data.priceAlerts[instId].push({
                        id: Date.now(),
                        price: parseFloat(price),
                        triggered: false
                    });
                    localStorage.setItem('priceAlerts', JSON.stringify(this.data.priceAlerts));
                    this.showStatus(`已设置价格提醒: ${instId} - ${price}`, 'success');
                    input.value = '';
                    this.updatePositions();
                }
            },

            removeAlert(instId, alertId) {
                if (this.data.priceAlerts[instId]) {
                    this.data.priceAlerts[instId] = this.data.priceAlerts[instId].filter(alert => alert.id !== alertId);
                    if (this.data.priceAlerts[instId].length === 0) delete this.data.priceAlerts[instId];
                    localStorage.setItem('priceAlerts', JSON.stringify(this.data.priceAlerts));
                    this.updatePositions();
                }
            },

            checkPriceAlerts() {
                let triggered = false;
                if (this.data.assets.positions) {
                    this.data.assets.positions.forEach(position => {
                        const alerts = this.data.priceAlerts[position.instId];
                        if (alerts) {
                            alerts.forEach(alert => {
                                if (!alert.triggered) {
                                    const currentPrice = position.markPx;
                                    if ((position.posSide === 'long' && currentPrice >= alert.price) ||
                                        (position.posSide === 'short' && currentPrice <= alert.price)) {
                                        this.playAlertSound();
                                        alert.triggered = true;
                                        this.showStatus(`🔔 价格提醒: ${position.instId} 达到 ${alert.price}`, 'success');
                                        triggered = true;
                                    }
                                }
                            });
                        }
                    });
                }
                if (triggered) {
                    localStorage.setItem('priceAlerts', JSON.stringify(this.data.priceAlerts));
                }
            },

            playAlertSound() {
                if (this.config.system.alertSound === 'none') return;
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1);
                } catch (e) {
                    console.log('音频播放失败');
                }
            },

            // 更新图表
            updateCharts() {
                if (this.data.assets.breakdown && this.data.assets.breakdown.length > 0) {
                    this.distributionChart.data.labels = this.data.assets.breakdown.map(asset => asset.name);
                    this.distributionChart.data.datasets[0].data = this.data.assets.breakdown.map(asset => parseFloat(asset.percentage));
                    this.distributionChart.update();
                }
                this.updateTrendChart();
            },

            // 更新趋势图
            updateTrendChart() {
                if (this.data.historical.length === 0) {
                    this.trendChart.data.labels = ['暂无数据'];
                    this.trendChart.data.datasets[0].data = [0];
                } else {
                    const now = Date.now();
                    let filteredData = this.data.historical;
                    
                    switch(this.data.currentTrendPeriod) {
                        case '24h': filteredData = this.data.historical.filter(item => now - item.timestamp <= 24 * 60 * 60 * 1000); break;
                        case '7d': filteredData = this.data.historical.filter(item => now - item.timestamp <= 7 * 24 * 60 * 60 * 1000); break;
                        case '30d': filteredData = this.data.historical.filter(item => now - item.timestamp <= 30 * 24 * 60 * 60 * 1000); break;
                    }
                    
                    if (filteredData.length > 50) {
                        const step = Math.ceil(filteredData.length / 50);
                        filteredData = filteredData.filter((_, index) => index % step === 0);
                    }
                    
                    this.trendChart.data.labels = filteredData.map(item => {
                        return this.data.currentTrendPeriod === '24h' ? item.time : new Date(item.timestamp).toLocaleDateString();
                    });
                    this.trendChart.data.datasets[0].data = filteredData.map(item => item.total);
                }
                this.trendChart.update();
            },

            // 更新时间
            updateTime() {
                const element = document.getElementById('update-time');
                if (element) {
                    element.textContent = new Date().toLocaleTimeString();
                }
            },

            // 更新变化文本
            updateChangeText() {
                const texts = this.translations[this.config.system.language];
                let changeText = texts.change24h;
                
                switch(this.data.currentTrendPeriod) {
                    case '24h': changeText = texts.change24h; break;
                    case '7d': changeText = texts.change7d; break;
                    case '30d': changeText = texts.change30d; break;
                }
                
                document.getElementById('change-text').textContent = changeText;
                this.updateChangeDisplay();
            },

            // 更新变化显示
            updateChangeDisplay() {
                const changeElement = document.getElementById('change-display');
                let changeValue = 0;
                
                switch(this.data.currentTrendPeriod) {
                    case '24h': changeValue = this.data.assets.change24h || 0; break;
                    case '7d': changeValue = this.data.assets.change7d || 0; break;
                    case '30d': changeValue = this.data.assets.change30d || 0; break;
                }
                
                const changeClass = changeValue >= 0 ? 'positive' : 'negative';
                const changeSymbol = changeValue >= 0 ? '+' : '';
                
                changeElement.innerHTML = `
                    <span id="change-text">${document.getElementById('change-text').textContent}</span>: 
                    <span class="${changeClass}">${changeSymbol}${this.formatNumber(changeValue)}%</span>
                `;
            },

            // 获取汇率
            async fetchExchangeRates() {
                try {
                    const response = await fetch('https://api.exchangerate.host/latest?base=USD');
                    if (response.ok) {
                        const data = await response.json();
                        this.data.exchangeRates.USDCNY = data.rates.CNY || 7.2;
                    }
                } catch (error) {
                    console.log('获取汇率失败');
                }
            },

            // 显示状态消息
            showStatus(message, type) {
                const element = document.getElementById('api-status');
                if (element) {
                    element.textContent = message;
                    element.className = `status ${type}`;
                    setTimeout(() => {
                        element.textContent = '';
                        element.className = 'status';
                    }, 5000);
                }
            },

            // === 工具方法 ===
            convertToUnit(value, unit) {
                switch(unit) {
                    case 'CNY': return value * this.data.exchangeRates.USDCNY;
                    case 'BTC': return value * this.data.exchangeRates.USDBTC;
                    default: return value;
                }
            },

            getUnitSymbol(unit) {
                switch(unit) {
                    case 'CNY': return '¥';
                    case 'BTC': return '₿';
                    default: return '$';
                }
            },

            formatNumber(num, decimals = 2) {
                if (isNaN(num)) return '0.00';
                return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            }
        };

        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });
    </script>
</body>
</html>
